<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="theme-color" content="#0a0a0f"/>
<title>Mo's Wellness App</title>
<style>
/* --- GLOBAL STYLES --- */
:root {
    --bg: #0a0a0f; --card: #13131a; --card2: #1a1a24; --text: #f0ede8;
    --sub: #9a8fa0; --border: #2a2a3a; --accent: #00d68f; --pink: #e84585;
    --blue: #3498db; --purple: #9b59b6; --gold: #f5a623; 
    --lemon: #f1c40f; --aqua: #00ced1; --white: #ffffff; --red: #e84545;
}
* { box-sizing: border-box; margin: 0; padding: 0; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
body { background: var(--bg); color: var(--text); padding: 14px 14px 90px; max-width: 500px; margin: 0 auto; user-select: none; }

.header { background: linear-gradient(135deg, #1a0a2e 0%, #16213e 100%); padding: 18px; border-radius: 20px; margin-bottom: 15px; }
.card { background: var(--card); border-radius: 20px; padding: 16px; margin-bottom: 15px; border: 1px solid var(--border); }
.flex-sb { display: flex; justify-content: space-between; align-items: center; }

/* Grids */
.week-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-top: 15px; }
.grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
.grid3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
.grid5 { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; margin-bottom: 12px; }
.grid-half { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.grid-2-1 { display: grid; grid-template-columns: 2fr 1fr; gap: 8px; margin-bottom: 10px; }

/* Ring & Tracker Elements */
.day-btn { display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; background: none; border: none; color: inherit; }
.ring-stack { position: relative; display: flex; align-items: center; justify-content: center; }
.ring-stack svg { position: absolute; inset: 0; pointer-events: none; }
.legend { display: flex; justify-content: center; gap: 8px; font-size: 9px; color: rgba(255,255,255,0.7); margin-top: 10px; flex-wrap: wrap; font-weight: 700; }

/* Inputs & Buttons */
input, textarea { background: #000; color: #fff; border: 1px solid var(--border); border-radius: 10px; padding: 10px; width: 100%; outline: none; font-size: 14px; user-select: text;}
input.text-left { text-align: left; }
input::placeholder { color: #666; font-size: 11px; }

.btn-log { background: var(--accent); color: #fff; padding: 10px; border-radius: 10px; font-weight: 700; border: none; cursor: pointer; }
.btn-danger { background: #e84545; color: #fff; padding: 10px; border-radius: 10px; font-weight: 700; border: none; cursor: pointer; width: 100%; }
.btn-add { width: 100%; padding: 12px; background: transparent; border: 1px dashed var(--sub); color: var(--sub); border-radius: 15px; font-weight: 700; margin-top: 5px; cursor: pointer;}
.btn-pink { background: var(--pink); color: #fff; padding: 12px; border-radius: 10px; font-weight: 700; border: none; cursor: pointer; width: 100%; }
.btn-green { background: var(--accent); color: #fff; padding: 12px; border-radius: 10px; font-weight: 700; border: none; cursor: pointer; width: 100%; }
.btn-blue { background: var(--blue); color: #fff; padding: 12px; border-radius: 10px; font-weight: 700; border: none; cursor: pointer; width: 100%; }
.btn-purple { background: var(--purple); color: #fff; padding: 12px; border-radius: 10px; font-weight: 700; border: none; cursor: pointer; width: 100%; }
.btn-gold { background: var(--gold); color: #000; padding: 12px; border-radius: 10px; font-weight: 800; border: none; cursor: pointer; width: 100%; }
.btn-primary { background: linear-gradient(135deg, #00d68f, #3498db); color: #fff; padding: 14px; border-radius: 14px; font-weight: 800; border: none; cursor: pointer; width: 100%; font-size: 15px; }
.del-btn { background: none; color: #e84545; border: none; font-size: 16px; font-weight: bold; cursor: pointer; padding: 0 5px; }

/* Lists & Rows */
.mon-row { display: flex; justify-content: space-between; border-bottom: 1px solid var(--border); padding: 8px 0; cursor: pointer; font-size: 12px; }
.mon-row:active { background: var(--card2); }
.food-row, .drink-row, .fast-row, .history-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); font-size: 14px; }
.food-row:last-child, .drink-row:last-child, .fast-row:last-child, .history-row:last-child { border-bottom: none; padding-bottom: 0; }
.macro-badge { font-size: 10px; color: var(--sub); display: flex; gap: 6px; margin-top: 4px; }

/* Specific Components */
.ritual-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--card2); border-radius: 15px; margin-bottom: 8px; cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
.ritual-item.checked { border: 1px solid var(--accent); background: rgba(0, 214, 143, 0.05); }
.cb-container { width: 22px; height: 22px; border: 2px solid var(--border); border-radius: 6px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
.ritual-item.checked .cb-container { background: var(--accent); border-color: var(--accent); }
.cb-container::after { content: '‚úì'; color: white; font-size: 14px; display: none; }
.ritual-item.checked .cb-container::after { display: block; }

.pink-card { background: rgba(232, 69, 133, 0.05); border: 2px solid var(--pink); border-radius: 20px; padding: 16px; margin-bottom: 15px; }
.plan-card { background: rgba(0, 214, 143, 0.05); border: 2px solid var(--accent); border-radius: 20px; padding: 16px; margin-bottom: 15px; }
.tea-card { background: rgba(155, 89, 182, 0.05); border: 2px solid var(--purple); border-radius: 20px; padding: 16px; margin-bottom: 15px; }
.timer-card { background: linear-gradient(135deg, rgba(0,214,143,0.1), rgba(52,152,219,0.1)); border: 1px solid var(--accent); text-align: center; }
.timer-active { background: linear-gradient(135deg, #0f3460, #533483); border: 1px solid var(--purple); }

.drink-opt { background: var(--card2); border: 1px solid var(--border); border-radius: 12px; padding: 12px 5px; text-align: center; cursor: pointer; transition: 0.2s; }
.drink-opt.active { border-color: var(--blue); background: rgba(52, 152, 219, 0.1); }

/* Graphical Elements (Plan/Stats) */
.timeline { position: relative; padding-left: 20px; margin-top: 10px; }
.timeline::before { content: ''; position: absolute; left: 6px; top: 0; bottom: 0; width: 2px; background: var(--border); border-radius: 2px; }
.tl-node { position: relative; margin-bottom: 25px; padding-left: 15px; }
.tl-node:last-child { margin-bottom: 0; }
.tl-dot { position: absolute; left: -22px; top: 2px; width: 14px; height: 14px; border-radius: 50%; background: var(--card); border: 3px solid var(--sub); z-index: 2; }
.tl-node.active .tl-dot { border-color: var(--gold); background: var(--gold); box-shadow: 0 0 10px rgba(245, 166, 35, 0.5); }
.tl-node.completed .tl-dot { border-color: var(--accent); background: var(--accent); }
.tl-title { font-weight: 800; font-size: 14px; color: var(--text); display: flex; justify-content: space-between; }
.tl-desc { font-size: 11px; color: var(--sub); margin-top: 4px; line-height: 1.4; }
.badge { background: var(--card2); padding: 4px 8px; border-radius: 8px; font-size: 10px; font-weight: 700; color: var(--accent); }

.bmi-gauge-container { margin-top: 15px; position: relative; padding-bottom: 10px; }
.bmi-track { height: 12px; border-radius: 10px; background: linear-gradient(to right, #3498db 20%, #00d68f 40%, #f5a623 70%, #e84545 100%); width: 100%; position: relative; }
.bmi-marker { position: absolute; top: -18px; transform: translateX(-50%); font-size: 18px; transition: left 0.5s ease; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
.bmi-labels { display: flex; justify-content: space-between; font-size: 9px; color: var(--sub); margin-top: 6px; font-weight: 700; text-transform: uppercase; }

/* Overlays & Tab Bar */
.overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.96); z-index: 1000; padding: 25px; display: none; overflow-y: auto; }
.tab-content { display: none; animation: fadeIn 0.3s ease; }
.tab-content.active-tab { display: block; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.tab-bar { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 500px; background: var(--card); border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 12px 0 20px; z-index: 50; }
.tab-btn { background: none; border: none; color: var(--sub); font-size: 22px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: 0.2s;}
.tab-btn span { font-size: 9px; font-weight: 700; }
.tab-btn.active { color: var(--accent); transform: translateY(-2px);}
</style>
</head>
<body>

<div id="tab-home" class="tab-content active-tab">
    <div class="header">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div><p style="font-size:10px; color:rgba(255,255,255,0.6);">Welcome back</p><h1 style="font-size:26px;">Mo' üåü</h1></div>
            <div style="font-size:20px; background:rgba(255,255,255,0.1); padding:8px; border-radius:50%;">üåô</div>
        </div>
        <div class="week-grid" id="homeWeekGrid"></div>
    </div>

    <div class="card">
        <div class="flex-sb" style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <h3>üë§ Rituals</h3>
            <span id="homeRitualPct" style="color:var(--accent); font-weight:700;">0%</span>
        </div>
        <div id="homeRitualsContainer"></div>
        <button class="btn-add" onclick="addNewRitual()">+ Add Custom Ritual</button>
    </div>

    <div class="grid2">
        <div class="card">
            <h3>üò¥ Sleep</h3>
            <div style="display:flex; gap:6px; margin-top:8px;"><input type="number" id="homeSleepIn" placeholder="Hrs"><button class="btn-log" onclick="quickLog('sleep')">Log</button></div>
        </div>
        <div class="card">
            <h3>üëü Steps</h3>
            <div style="display:flex; gap:6px; margin-top:8px;"><input type="number" id="homeStepIn" placeholder="Add"><button class="btn-log" onclick="quickLog('steps')">+</button></div>
        </div>
    </div>

    <div class="card">
        <h3>üìà Week Monitor (Tap to Edit)</h3>
        <div id="homeMonitorList" style="margin-top:10px;"></div>
    </div>

    <div id="homeLogOverlay" class="overlay">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h2 id="homeLogTitle">Day History</h2>
            <button onclick="closeHomeLog()" style="background:none; color:#fff; font-size:30px; border:none;">‚úï</button>
        </div>
        <div class="card">
            <label>CALORIES</label><input type="number" id="homeHCal" style="margin-bottom:12px;">
            <label>EXERCISE</label><input type="number" id="homeHEx" style="margin-bottom:12px;">
            <label>WATER</label><input type="number" id="homeHWat" style="margin-bottom:12px;">
            <label>SLEEP (Hrs)</label><input type="number" id="homeHSleep" style="margin-bottom:12px;">
            <label>STEPS</label><input type="number" id="homeHSteps" style="margin-bottom:12px;">
            <label>DAILY PECULIARITIES</label><textarea id="homeHPec" style="height:60px; margin-bottom:20px;"></textarea>
            
            <div class="grid2">
                <button class="btn-log" onclick="saveHomeDay()">Update All</button>
                <button class="btn-danger" onclick="deleteHomeDayLog()">Wipe Day</button>
            </div>
        </div>
    </div>
</div>

<div id="tab-food" class="tab-content">
    <div class="header">
        <div class="flex-sb">
            <div><h1 style="font-size:22px;">üçΩÔ∏è Food & Nutrients</h1><p style="font-size:11px; color:rgba(255,255,255,0.7); margin-top:4px;">Log meals and track your macros</p></div>
        </div>
        <div class="week-grid" id="foodWeekGrid"></div>
        <div class="legend">
            <span><b style="color:var(--accent);">üü¢</b> Prot</span>
            <span><b style="color:var(--red);">üî¥</b> Carb</span>
            <span><b style="color:var(--gold);">üü†</b> Fat</span>
            <span><b style="color:var(--blue);">üîµ</b> Fib</span>
            <span><b style="color:var(--white);">‚ö™</b> Oth</span>
        </div>
    </div>

    <div class="card">
        <div class="flex-sb" style="margin-bottom:10px;">
            <div><div style="font-size:12px; color:var(--sub); font-weight:700;">EATEN (<span id="foodActiveDayLabel">Today</span>)</div><div id="foodCalsEaten" style="font-weight:900; color:var(--pink); font-size:24px;">0</div></div>
            <div style="text-align:right;"><div style="font-size:12px; color:var(--sub); font-weight:700;">REMAINING</div><div id="foodCalsLeft" style="font-weight:900; color:var(--accent); font-size:24px;">1400</div></div>
        </div>
        <div style="height:8px; background:var(--border); border-radius:10px; overflow:hidden;">
            <div id="foodCalBar" style="height:100%; background:var(--pink); width:0%; transition: width 0.3s;"></div>
        </div>
    </div>

    <div class="pink-card">
        <h3 style="color:var(--text); margin-bottom:4px;">‚úèÔ∏è Quick Meal Log</h3>
        <p style="font-size:11px; color:var(--sub); margin-bottom:12px;">Type what you ate + calories & macros.</p>
        <div class="grid-2-1">
            <input type="text" id="foodQmName" class="text-left" placeholder="e.g. Egusi + Eba">
            <input type="number" id="foodQmCal" placeholder="kcal" style="text-align:center;">
        </div>
        <div class="grid5">
            <input type="number" id="foodQmProt" placeholder="Prot" style="text-align:center;">
            <input type="number" id="foodQmCarb" placeholder="Carb" style="text-align:center;">
            <input type="number" id="foodQmFat" placeholder="Fat" style="text-align:center;">
            <input type="number" id="foodQmFib" placeholder="Fib" style="text-align:center;">
            <input type="number" id="foodQmOth" placeholder="Oth" style="text-align:center;">
        </div>
        <button class="btn-pink" onclick="logFoodMeal('quick')">+ Log Meal</button>
    </div>

    <div class="plan-card">
        <h3 style="color:var(--text); margin-bottom:4px;">üìÖ Meal Plan Logger</h3>
        <p style="font-size:11px; color:var(--sub); margin-bottom:12px;">Log your planned daily meals here.</p>
        <div class="grid-2-1">
            <input type="text" id="foodMpName" class="text-left" placeholder="Planned Meal (e.g. Keto Bowl)">
            <input type="number" id="foodMpCal" placeholder="kcal" style="text-align:center;">
        </div>
        <div class="grid5">
            <input type="number" id="foodMpProt" placeholder="Prot" style="text-align:center;">
            <input type="number" id="foodMpCarb" placeholder="Carb" style="text-align:center;">
            <input type="number" id="foodMpFat" placeholder="Fat" style="text-align:center;">
            <input type="number" id="foodMpFib" placeholder="Fib" style="text-align:center;">
            <input type="number" id="foodMpOth" placeholder="Oth" style="text-align:center;">
        </div>
        <button class="btn-green" onclick="logFoodMeal('plan')">+ Add to Plan</button>
    </div>

    <div class="card">
        <h3 style="margin-bottom:10px;" id="foodMainLogTitle">üìã Today's Food Log</h3>
        <div id="foodList">
            <p style="font-size:12px; color:var(--sub); text-align:center; padding:10px 0;">No food logged yet.</p>
        </div>
    </div>

    <div id="foodLogOverlay" class="overlay">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 id="foodLogTitle">Edit History</h2>
            <button onclick="closeFoodLog()" style="background:none; color:#fff; font-size:30px; border:none; cursor:pointer;">‚úï</button>
        </div>
        <div class="card">
            <h3 style="margin-bottom: 10px; color:var(--gold);">Logged Meals</h3>
            <div id="foodOverlayFoodList" style="margin-bottom: 15px;"></div>
            
            <div style="border-top: 1px solid var(--border); padding-top: 15px; margin-bottom: 20px;">
                <label style="font-size:11px; color:var(--pink); font-weight:700; margin-bottom:10px; display:block;">MANUAL NUTRIENT OVERRIDE</label>
                <input type="number" id="foodHCal" class="text-left" placeholder="Total Calories (kcal)" style="margin-bottom:10px;">
                <div class="grid5">
                    <input type="number" id="foodHProt" placeholder="Prot" style="text-align:center;">
                    <input type="number" id="foodHCarb" placeholder="Carb" style="text-align:center;">
                    <input type="number" id="foodHFat" placeholder="Fat" style="text-align:center;">
                    <input type="number" id="foodHFib" placeholder="Fib" style="text-align:center;">
                    <input type="number" id="foodHOth" placeholder="Oth" style="text-align:center;">
                </div>
            </div>
            
            <div class="grid-half">
                <button class="btn-green" onclick="saveFoodDay()">Save Edits</button>
                <button class="btn-danger" onclick="deleteFoodDayLog()">Wipe Day</button>
            </div>
        </div>
    </div>
</div>

<div id="tab-hydration" class="tab-content">
    <div class="header">
        <div class="flex-sb">
            <div><h1 style="font-size:24px;">üíß Hydration</h1><p style="font-size:11px; color:rgba(255,255,255,0.7); margin-top:4px;">Daily Target: 8 Glasses</p></div>
        </div>
        <div class="week-grid" id="hydWeekGrid"></div>
        <div class="legend">
            <span><b style="color:var(--blue);">üîµ</b> Plain</span>
            <span><b style="color:var(--lemon);">üü°</b> Lemon</span>
            <span><b style="color:var(--purple);">üü£</b> Tea</span>
            <span><b style="color:var(--aqua);">ü©µ</b> Chia</span>
            <span><b style="color:var(--white);">‚ö™</b> Oth</span>
        </div>
    </div>

    <div class="card" style="text-align: center;">
        <p style="font-size:12px; color:var(--sub); font-weight:700; margin-bottom:5px;" id="hydActiveDayLabel">TODAY</p>
        <div style="font-size:54px; font-weight:900; color:var(--blue); line-height:1;"><span id="hydGlassCount">0</span><span style="font-size:20px; color:var(--sub);">/8</span></div>
        <div style="height:8px; background:var(--border); border-radius:10px; overflow:hidden; margin: 15px 0;">
            <div id="hydWaterBar" style="height:100%; background:var(--blue); width:0%; transition: width 0.3s;"></div>
        </div>

        <div class="grid3">
            <div class="drink-opt active" id="hyd-opt-plain" onclick="selectDrink('plain', 'Plain Water', 'üíß')">
                <div style="font-size:24px;">üíß</div><div style="font-size:10px; font-weight:700; margin-top:5px;">Plain</div>
            </div>
            <div class="drink-opt" id="hyd-opt-lemon" onclick="selectDrink('lemon', 'Lemon Warm Water', 'üçã')">
                <div style="font-size:24px;">üçã</div><div style="font-size:10px; font-weight:700; margin-top:5px;">Lemon</div>
            </div>
            <div class="drink-opt" id="hyd-opt-chia" onclick="selectDrink('chia', 'Chia Water', 'üå±')">
                <div style="font-size:24px;">üå±</div><div style="font-size:10px; font-weight:700; margin-top:5px;">Chia</div>
            </div>
        </div>
        <button class="btn-blue" onclick="logHydWater()">+ Log a Glass üíß</button>
    </div>

    <div class="card">
        <h3 style="color:var(--text); margin-bottom:12px; font-size:15px;">‚úèÔ∏è Log Custom Drink</h3>
        <div class="grid-2-1">
            <input type="text" id="hydCdName" class="text-left" placeholder="Drink Name (e.g. Sparkling)">
            <input type="text" id="hydCdEmoji" placeholder="Emoji ü•§" style="text-align:center;">
        </div>
        <button class="btn-blue" style="background:var(--card2); border:1px dashed var(--blue); color:var(--blue);" onclick="logHydCustomDrink()">+ Add Custom (Other)</button>
    </div>

    <div class="tea-card">
        <h3 style="color:var(--purple); margin-bottom:4px;">üåø Evening Protocol</h3>
        <p style="font-size:11px; color:var(--sub); margin-bottom:12px;">Last thing before bed (9 PM).</p>
        <div class="flex-sb" style="background:var(--card); padding:12px; border-radius:12px;">
            <div>
                <div style="font-weight:700; font-size:14px;">Wellness Tea</div>
                <div style="font-size:10px; color:var(--sub); margin-top:2px;">Fennel, Cloves, Ginger, Lemongrass...</div>
            </div>
            <button class="btn-purple" style="width:auto; padding:8px 15px; font-size:12px;" onclick="logHydWellnessTea()">Log Tea ‚úì</button>
        </div>
    </div>

    <div class="card">
        <h3 style="margin-bottom:10px;" id="hydMainLogTitle">üìã Today's Hydration Log</h3>
        <div id="hydDrinkList">
            <p style="font-size:12px; color:var(--sub); text-align:center; padding:10px 0;">No water logged yet.</p>
        </div>
    </div>

    <div id="hydLogOverlay" class="overlay">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 id="hydLogTitle">Edit History</h2>
            <button onclick="closeHydLog()" style="background:none; color:#fff; font-size:30px; border:none; cursor:pointer;">‚úï</button>
        </div>
        <div class="card">
            <h3 style="margin-bottom: 10px; color:var(--blue);">Logged Drinks</h3>
            <div id="hydOverlayDrinkList" style="margin-bottom: 15px;"></div>
            
            <div style="border-top: 1px solid var(--border); padding-top: 15px; margin-bottom: 20px;">
                <label style="font-size:11px; color:var(--blue); font-weight:700; margin-bottom:10px; display:block;">MANUAL CATEGORY OVERRIDE</label>
                <div class="grid5">
                    <input type="number" id="hydHPlain" placeholder="Plain" style="text-align:center;">
                    <input type="number" id="hydHLemon" placeholder="Lemon" style="text-align:center;">
                    <input type="number" id="hydHTea" placeholder="Tea" style="text-align:center;">
                    <input type="number" id="hydHChia" placeholder="Chia" style="text-align:center;">
                    <input type="number" id="hydHOth" placeholder="Oth" style="text-align:center;">
                </div>
            </div>
            
            <div class="grid-half">
                <button class="btn-blue" onclick="saveHydDay()">Save Edits</button>
                <button class="btn-danger" onclick="deleteHydDayLog()">Wipe Day</button>
            </div>
        </div>
    </div>
</div>

<div id="tab-fasting" class="tab-content">
    <div class="header">
        <div class="flex-sb">
            <div><h1 style="font-size:24px;">‚è±Ô∏è Fasting</h1><p style="font-size:11px; color:rgba(255,255,255,0.7); margin-top:4px;">Mo's 16:8 Window ¬∑ Target: 16h</p></div>
        </div>
        <div class="week-grid" id="fastWeekGrid"></div>
    </div>

    <div class="card timer-card" id="fastTimerContainer"></div>

    <div class="card">
        <h3 style="margin-bottom:10px;" id="fastMainLogTitle">üìã Today's Fasting History</h3>
        <div id="fastList">
            <p style="font-size:12px; color:var(--sub); text-align:center; padding:10px 0;">No fasts logged yet.</p>
        </div>
    </div>

    <div id="fastLogOverlay" class="overlay">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 id="fastLogTitle">Edit History</h2>
            <button onclick="closeFastLog()" style="background:none; color:#fff; font-size:30px; border:none; cursor:pointer;">‚úï</button>
        </div>
        <div class="card">
            <h3 style="margin-bottom: 10px; color:var(--accent);">Logged Fasts</h3>
            <div id="fastOverlayFastList" style="margin-bottom: 15px;"></div>
            
            <div style="border-top: 1px solid var(--border); padding-top: 15px; margin-bottom: 20px;">
                <label style="font-size:11px; color:var(--accent); font-weight:700;">MANUAL HOURS OVERRIDE</label>
                <p style="font-size:10px; color:var(--sub); margin-bottom:8px;">Edit total hours fasted directly if you forgot to run the timer.</p>
                <input type="number" id="fastHFast" placeholder="Override total hours (e.g. 16.5)" step="0.1" style="text-align:center;">
            </div>
            
            <div class="grid-half">
                <button class="btn-green" onclick="saveFastDay()">Save Edits</button>
                <button class="btn-danger" style="padding:12px; font-size:14px; border-radius:10px;" onclick="deleteFastDayLog()">Wipe Day</button>
            </div>
        </div>
    </div>
</div>

<div id="tab-plan" class="tab-content">
    <div class="header" style="background: linear-gradient(135deg, #2c3e50 0%, #1a0a2e 100%);">
        <h1 style="font-size:24px; color:#fff;">üó∫Ô∏è The Master Plan</h1>
        <div class="flex-sb" style="margin-top:10px;">
            <div><div style="font-size:10px; color:rgba(255,255,255,0.6);">START</div><div style="font-size:18px; font-weight:900;">70.25 <span style="font-size:12px; font-weight:normal;">kg</span></div></div>
            <div style="font-size:20px; color:var(--sub);">‚ûî</div>
            <div style="text-align:right;"><div style="font-size:10px; color:rgba(255,255,255,0.6);">GOAL</div><div style="font-size:18px; font-weight:900; color:var(--gold);">63.00 <span style="font-size:12px; font-weight:normal;">kg</span></div></div>
        </div>
    </div>

    <div class="card">
        <h3 style="margin-bottom:15px; color:var(--accent);">üìç 12-Week Roadmap</h3>
        <div class="timeline">
            <div class="tl-node completed">
                <div class="tl-dot"></div>
                <div class="tl-title">Phase 1: Foundation <span class="badge">Wk 1‚Äì4</span></div>
                <div class="tl-desc">Target: 68.0 kg (-2.25kg)<br>Focus: Build habits, reduce sugar, establish strict 16:8 IF window.</div>
            </div>
            <div class="tl-node active">
                <div class="tl-dot"></div>
                <div class="tl-title">Phase 2: Acceleration <span class="badge" style="background:rgba(245,166,35,0.1); color:var(--gold);">Wk 5‚Äì8</span></div>
                <div class="tl-desc">Target: 66.0 kg (-2.0kg)<br>Focus: 3x/week exercise, calorie cycling (weekdays stricter).</div>
            </div>
            <div class="tl-node">
                <div class="tl-dot"></div>
                <div class="tl-title">Phase 3: Final Push <span class="badge" style="background:var(--card2); color:var(--sub);">Wk 9‚Äì12</span></div>
                <div class="tl-desc">Target: 63.0 kg (-3.0kg)<br>Focus: Push hydration, increase protein, consistency wins! üéâ</div>
            </div>
        </div>
    </div>

    <div class="card" style="border: 1px solid var(--blue); background: rgba(52, 152, 219, 0.05);">
        <h3 style="margin-bottom:10px; color:var(--blue);">üå∏ Weekend Protocol</h3>
        <p style="font-size:12px; color:var(--text); margin-bottom:12px; line-height:1.5;">Don't stress ‚Äî Mon‚ÄìFri consistency is key. Keep weekends balanced:</p>
        <div style="display:flex; flex-direction:column; gap:8px;">
            <div style="background:var(--card); padding:10px; border-radius:10px; font-size:12px; display:flex; align-items:center; gap:10px;"><span style="font-size:16px;">‚è±Ô∏è</span> Allow 2-meal window: 12 PM ‚Äì 7 PM max</div>
            <div style="background:var(--card); padding:10px; border-radius:10px; font-size:12px; display:flex; align-items:center; gap:10px;"><span style="font-size:16px;">ü•í</span> Snacks: garden eggs, cucumber, roasted groundnut</div>
            <div style="background:var(--card); padding:10px; border-radius:10px; font-size:12px; display:flex; align-items:center; gap:10px;"><span style="font-size:16px;">üíÉ</span> Add 20-min walk or dance session</div>
        </div>
    </div>
</div>

<div id="tab-stats" class="tab-content">
    <div class="grid2">
        <div class="card" style="text-align:center; padding:12px;"><div style="font-size:10px; color:var(--sub);">CURRENT</div><div id="statCurrent" style="font-size:24px; font-weight:900; color:var(--text);">--</div></div>
        <div class="card" style="text-align:center; padding:12px; border-color:var(--gold);"><div style="font-size:10px; color:var(--gold);">TOTAL LOST</div><div id="statLost" style="font-size:24px; font-weight:900; color:var(--gold);">--</div></div>
    </div>

    <div class="card">
        <div class="flex-sb" style="margin-bottom:8px;">
            <h3 style="margin:0;">‚öñÔ∏è BMI Status</h3>
            <span id="bmiValue" style="font-weight:900; font-size:18px; color:var(--accent);">--</span>
        </div>
        <p id="bmiText" style="font-size:11px; color:var(--sub); margin-bottom:20px;">Calculating...</p>
        
        <div class="bmi-gauge-container">
            <div class="bmi-marker" id="bmiMarker">‚ñº</div>
            <div class="bmi-track"></div>
            <div class="bmi-labels">
                <span>Under</span>
                <span style="padding-left:15px;">Healthy</span>
                <span style="padding-left:15px;">Over</span>
                <span>Obese</span>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>üìà Weight Journey</h3>
        <canvas id="weightChart" style="width:100%; height:160px; margin-top:10px;"></canvas>
    </div>

    <div class="card">
        <h3 style="margin-bottom:12px;">‚ûï Log Weight</h3>
        <div style="display:flex; gap:10px;">
            <input type="number" id="statsWeightInput" placeholder="e.g. 68.5 kg" step="0.1" style="text-align:center;">
            <button class="btn-gold" style="width:100px;" onclick="logStatsWeight()">Save</button>
        </div>
    </div>

    <div class="card">
        <h3 style="margin-bottom:15px;">üéÅ Unlockable Rewards</h3>
        <div id="rewardsList"></div>
    </div>

    <div class="card">
        <h3 style="margin-bottom:10px;">üìã Weight History</h3>
        <div id="weightHistoryList"></div>
    </div>
</div>

<div class="tab-bar">
    <button class="tab-btn active" onclick="switchTab('home', this)">üè†<span>Home</span></button>
    <button class="tab-btn" onclick="switchTab('food', this)">üçΩÔ∏è<span>Food</span></button>
    <button class="tab-btn" onclick="switchTab('hydration', this)">üíß<span>Hydrate</span></button>
    <button class="tab-btn" onclick="switchTab('fasting', this)">‚è±Ô∏è<span>Fast</span></button>
    <button class="tab-btn" onclick="switchTab('plan', this)">üìã<span>Plan</span></button>
    <button class="tab-btn" onclick="switchTab('stats', this)">üìä<span>Stats</span></button>
</div>

<script>
// --- GLOBAL CONSTANTS & INITIALIZATION ---
const DAYS = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
let activeDay = DAYS[new Date().getDay()];

// Targets
const CAL_TARGET = 1400;
const WATER_TARGET = 8;
const FAST_TARGET = 16;
const FOOD_TARGETS = { cal: 1400, prot: 100, carb: 150, fat: 50, fib: 25, oth: 50 };
const HYD_TARGETS = { total: 8, plain: 4, lemon: 2, tea: 1, chia: 1, oth: 1 };

const STATS_PROFILE = { startWeight: 70.25, goalWeight: 63.0, heightCm: 162.56 };
const STATS_MILESTONES = [
    { kg: 3, icon: "üõÅ", title: "Luxe Bath Ritual", desc: "Oils, candles & relaxing music" },
    { kg: 6, icon: "üëó", title: "New Outfit", desc: "Buy that dress you've been eyeing" },
    { kg: 7.25, icon: "üéâ", title: "Goal Achieved!", desc: "Full wellness day / spa celebration" }
];

// Databases
let homeRituals = JSON.parse(localStorage.getItem('mo_rituals')) || [
    { n: 'Ginger Shot', t: '8 AM', e: 'ü´ö' },
    { n: 'Warm Water & Lime', t: '8 AM', e: 'üçà' },
    { n: 'Black Coffee', t: '8‚Äì9 AM', e: '‚òï' },
    { n: 'Wellness Tea', t: '9 PM', e: 'üåø' }
];

let weightLog = JSON.parse(localStorage.getItem('mo_weights')) || [
    { date: "Day 1", weight: STATS_PROFILE.startWeight, id: 0 }
];

let fastIsFasting = JSON.parse(localStorage.getItem('mo_isFasting')) || false;
let fastStartTime = JSON.parse(localStorage.getItem('mo_fastStartTime')) || null;
let fastTimerInterval;
let hydCurrentDrink = { id: 'plain', name: 'Plain Water', emoji: 'üíß' };

let history = JSON.parse(localStorage.getItem('mo_history')) || {};
DAYS.forEach(d => { 
    if(!history[d]) {
        history[d] = {
            cal:0, ex:0, wat:0, rit:0, sleep:0, steps:0, pec:'',
            meals:[], prot:0, carb:0, fat:0, fib:0, oth:0,
            drinks:[], plain:0, lemon:0, tea:0, chia:0, othWat:0,
            fastHours:0, fasts:[]
        };
    } else {
        // Ensure missing arrays/objects exist in older cache
        if(!history[d].meals) history[d].meals = [];
        if(!history[d].drinks) history[d].drinks = [];
        if(!history[d].fasts) history[d].fasts = [];
        ['prot','carb','fat','fib','oth','plain','lemon','tea','chia','othWat'].forEach(k => {
            if(history[d][k] === undefined) history[d][k] = 0;
        });
        if(history[d].fastHours === undefined) history[d].fastHours = 0;
    }
});

// Generic Draw Ring Function
function drawRing(pct, col, size, stroke) {
    const r = (size - stroke * 2) / 2; const c = 2 * Math.PI * r;
    return `<svg width="${size}" height="${size}">
        <circle cx="${size/2}" cy="${size/2}" r="${r}" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="${stroke}"/>
        <circle cx="${size/2}" cy="${size/2}" r="${r}" fill="none" stroke="${col}" stroke-width="${stroke}" 
            stroke-dasharray="${(Math.min(pct,100)/100)*c} ${c}" stroke-linecap="round" style="transform:rotate(-90deg); transform-origin:50% 50%"/>
    </svg>`;
}

// Master Update Function
function updateAllUI() {
    updateHomeUI();
    updateFoodUI();
    updateHydrationUI();
    updateFastingUI();
    updateStatsUI();
    localStorage.setItem('mo_history', JSON.stringify(history));
}

// --- TAB SWITCHING ---
function switchTab(tabId, btn) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active-tab'));
    document.getElementById(`tab-${tabId}`).classList.add('active-tab');
    
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    if(tabId === 'stats') {
        setTimeout(drawChart, 50); // Delay for canvas render
    }
}

// ==========================================
// HOME TAB LOGIC
// ==========================================
function updateHomeUI() {
    const grid = document.getElementById('homeWeekGrid'); grid.innerHTML = '';
    const monitor = document.getElementById('homeMonitorList'); monitor.innerHTML = '';

    DAYS.forEach(d => {
        const dData = history[d];
        const div = document.createElement('div');
        div.className = 'day-btn';
        div.onclick = () => openHomeLog(d);
        div.innerHTML = `<span style="font-size:9px; color:${d===activeDay?'#f5a623':'#9a8fa0'}">${d}</span>
            <div class="ring-stack" style="width:44px; height:44px;">
                ${drawRing((dData.cal/1400)*100, '#e84585', 44, 3)}
                <div style="position:absolute; inset:4px">${drawRing((dData.ex/300)*100, '#00d68f', 36, 3)}</div>
                <div style="position:absolute; inset:8px">${drawRing((dData.wat/8)*100, '#3498db', 28, 3)}</div>
                <div style="position:absolute; inset:12px">${drawRing((dData.rit/homeRituals.length)*100, '#9b59b6', 20, 3)}</div>
            </div>`;
        grid.appendChild(div);
        
        monitor.innerHTML += `<div class="mon-row" onclick="openHomeLog('${d}')">
            <span>${d}</span> <span>üëü ${dData.steps}</span> <span>üò¥ ${dData.sleep}h</span> <span>${dData.pec ? 'üìù' : ''}</span>
        </div>`;
    });
    document.getElementById('homeRitualPct').innerText = Math.round((history[activeDay].rit / homeRituals.length) * 100) + '%';
}

function initRituals() {
    const container = document.getElementById('homeRitualsContainer'); container.innerHTML = '';
    homeRituals.forEach((rit, idx) => {
        const div = document.createElement('div');
        div.className = 'ritual-item';
        if (idx < history[activeDay].rit) div.classList.add('checked');
        div.innerHTML = `<span style="font-size:22px;">${rit.e}</span>
            <div style="flex:1;"><div style="font-weight:700; font-size:14px;">${rit.n}</div><div style="font-size:11px; color:var(--sub);">${rit.t}</div></div>
            <div class="cb-container"></div>`;
        div.onclick = () => { div.classList.toggle('checked'); updateRitCount(); };
        container.appendChild(div);
    });
}

function updateRitCount() { 
    history[activeDay].rit = document.getElementById('homeRitualsContainer').querySelectorAll('.ritual-item.checked').length; 
    updateAllUI(); 
}

function addNewRitual() {
    const n = prompt("Name?"), t = prompt("Time?"), e = prompt("Emoji?");
    if(n && t) { homeRituals.push({n, t, e: e || '‚ú®'}); localStorage.setItem('mo_rituals', JSON.stringify(homeRituals)); initRituals(); updateAllUI(); }
}

function quickLog(type) {
    const val = type === 'sleep' ? document.getElementById('homeSleepIn').value : document.getElementById('homeStepIn').value;
    if(val) { if(type==='sleep') history[activeDay].sleep = parseFloat(val); else history[activeDay].steps += parseInt(val); updateAllUI(); }
}

function openHomeLog(day) {
    activeDay = day; const dData = history[day];
    document.getElementById('homeLogTitle').innerText = `${day} Log`;
    document.getElementById('homeHCal').value = dData.cal || "";
    document.getElementById('homeHEx').value = dData.ex || "";
    document.getElementById('homeHWat').value = dData.wat || "";
    document.getElementById('homeHSleep').value = dData.sleep || "";
    document.getElementById('homeHSteps').value = dData.steps || "";
    document.getElementById('homeHPec').value = dData.pec || "";
    document.getElementById('homeLogOverlay').style.display = 'block';
    initRituals();
    updateAllUI(); // sync other visual active days
}

function saveHomeDay() {
    history[activeDay].cal = parseInt(document.getElementById('homeHCal').value) || 0;
    history[activeDay].ex = parseInt(document.getElementById('homeHEx').value) || 0;
    history[activeDay].wat = parseInt(document.getElementById('homeHWat').value) || 0;
    history[activeDay].sleep = parseFloat(document.getElementById('homeHSleep').value) || 0;
    history[activeDay].steps = parseInt(document.getElementById('homeHSteps').value) || 0;
    history[activeDay].pec = document.getElementById('homeHPec').value;
    closeHomeLog();
}

function deleteHomeDayLog() { 
    if(confirm("Wipe day?")) { 
        history[activeDay].cal=0; history[activeDay].ex=0; history[activeDay].wat=0; 
        history[activeDay].rit=0; history[activeDay].sleep=0; history[activeDay].steps=0; history[activeDay].pec=''; 
        initRituals(); closeHomeLog(); 
    } 
}

function closeHomeLog() { 
    document.getElementById('homeLogOverlay').style.display = 'none'; 
    activeDay = DAYS[new Date().getDay()];
    initRituals();
    updateAllUI();
}

// ==========================================
// FOOD TAB LOGIC
// ==========================================
function updateFoodUI() {
    const grid = document.getElementById('foodWeekGrid'); grid.innerHTML = '';
    DAYS.forEach(d => {
        const h = history[d];
        grid.innerHTML += `
            <div class="day-btn" onclick="openFoodLog('${d}')">
                <span style="font-size:9px; color:${d===activeDay?'#e84585':'#9a8fa0'}; font-weight:700;">${d}</span>
                <div class="ring-stack" style="width:48px; height:48px;">
                    ${drawRing((h.prot/FOOD_TARGETS.prot)*100, 'var(--accent)', 48, 3)}
                    <div style="position:absolute; inset:4px">${drawRing((h.carb/FOOD_TARGETS.carb)*100, 'var(--red)', 40, 3)}</div>
                    <div style="position:absolute; inset:8px">${drawRing((h.fat/FOOD_TARGETS.fat)*100, 'var(--gold)', 32, 3)}</div>
                    <div style="position:absolute; inset:12px">${drawRing((h.fib/FOOD_TARGETS.fib)*100, 'var(--blue)', 24, 3)}</div>
                    <div style="position:absolute; inset:16px">${drawRing((h.oth/FOOD_TARGETS.oth)*100, 'var(--white)', 16, 3)}</div>
                </div>
            </div>`;
    });

    const isToday = activeDay === DAYS[new Date().getDay()];
    document.getElementById('foodActiveDayLabel').innerText = isToday ? "Today" : activeDay;
    document.getElementById('foodMainLogTitle').innerText = isToday ? "üìã Today's Food Log" : `üìã ${activeDay}'s Food Log`;

    const eaten = history[activeDay].cal;
    const remaining = Math.max(0, FOOD_TARGETS.cal - eaten);
    
    document.getElementById('foodCalsEaten').innerText = eaten;
    document.getElementById('foodCalsLeft').innerText = remaining;
    document.getElementById('foodCalsLeft').style.color = remaining === 0 ? '#e84545' : '#00d68f';
    document.getElementById('foodCalBar').style.width = Math.min(100, (eaten / FOOD_TARGETS.cal) * 100) + '%';

    const foodList = document.getElementById('foodList');
    if (history[activeDay].meals.length === 0) {
        foodList.innerHTML = `<p style="font-size:12px; color:var(--sub); text-align:center; padding:10px 0;">No food logged yet.</p>`;
    } else {
        foodList.innerHTML = '';
        history[activeDay].meals.forEach((meal, index) => {
            foodList.innerHTML += `
                <div class="food-row">
                    <div>
                        <span style="font-size:16px; margin-right:6px;">${meal.type === 'plan' ? 'üìÖ' : 'üçΩÔ∏è'}</span>
                        <span style="font-weight:700;">${meal.name}</span>
                        <div class="macro-badge">P:${meal.prot}g | C:${meal.carb}g | F:${meal.fat}g</div>
                    </div>
                    <div class="flex-sb" style="gap:15px; align-items:flex-start;">
                        <span style="color:var(--pink); font-weight:700; margin-top:2px;">${meal.cal} kcal</span>
                        <button class="del-btn" onclick="deleteFoodMeal(${index})">‚úï</button>
                    </div>
                </div>`;
        });
    }
}

function logFoodMeal(type) {
    const prefix = type === 'quick' ? 'foodQm' : 'foodMp';
    const name = document.getElementById(`${prefix}Name`).value;
    const cal = parseInt(document.getElementById(`${prefix}Cal`).value);
    
    if (name && cal) {
        const meal = {
            name: name, cal: cal, type: type,
            prot: parseInt(document.getElementById(`${prefix}Prot`).value) || 0,
            carb: parseInt(document.getElementById(`${prefix}Carb`).value) || 0,
            fat: parseInt(document.getElementById(`${prefix}Fat`).value) || 0,
            fib: parseInt(document.getElementById(`${prefix}Fib`).value) || 0,
            oth: parseInt(document.getElementById(`${prefix}Oth`).value) || 0
        };
        history[activeDay].meals.push(meal);
        history[activeDay].cal += meal.cal;
        history[activeDay].prot += meal.prot;
        history[activeDay].carb += meal.carb;
        history[activeDay].fat += meal.fat;
        history[activeDay].fib += meal.fib;
        history[activeDay].oth += meal.oth;

        ['Name','Cal','Prot','Carb','Fat','Fib','Oth'].forEach(id => { document.getElementById(`${prefix}${id}`).value = ''; });
        updateAllUI();
    } else alert("Please enter at least the meal name and total calories.");
}

function deleteFoodMeal(index) {
    const meal = history[activeDay].meals[index];
    history[activeDay].cal = Math.max(0, history[activeDay].cal - meal.cal);
    history[activeDay].prot = Math.max(0, history[activeDay].prot - meal.prot);
    history[activeDay].carb = Math.max(0, history[activeDay].carb - meal.carb);
    history[activeDay].fat = Math.max(0, history[activeDay].fat - meal.fat);
    history[activeDay].fib = Math.max(0, history[activeDay].fib - meal.fib);
    history[activeDay].oth = Math.max(0, history[activeDay].oth - meal.oth);
    history[activeDay].meals.splice(index, 1);
    updateAllUI();
}

function openFoodLog(day) {
    activeDay = day; const h = history[day];
    document.getElementById('foodLogTitle').innerText = `${day}'s Log Book`;
    document.getElementById('foodHCal').value = h.cal || "";
    document.getElementById('foodHProt').value = h.prot || "";
    document.getElementById('foodHCarb').value = h.carb || "";
    document.getElementById('foodHFat').value = h.fat || "";
    document.getElementById('foodHFib').value = h.fib || "";
    document.getElementById('foodHOth').value = h.oth || "";
    
    renderFoodOverlayMeals();
    document.getElementById('foodLogOverlay').style.display = 'block';
    updateAllUI();
}

function renderFoodOverlayMeals() {
    const list = document.getElementById('foodOverlayFoodList');
    if (history[activeDay].meals.length === 0) {
        list.innerHTML = `<p style="font-size:12px; color:var(--sub); padding:10px 0;">No food logged.</p>`;
    } else {
        list.innerHTML = '';
        history[activeDay].meals.forEach((meal, index) => {
            list.innerHTML += `
                <div class="food-row" style="padding: 8px 0;">
                    <div><span>${meal.type === 'plan' ? 'üìÖ' : 'üçΩÔ∏è'}</span> <span style="margin-left:5px; font-weight:700;">${meal.name}</span>
                    <div style="font-size:9px; color:var(--sub); margin-top:2px;">P:${meal.prot} C:${meal.carb} F:${meal.fat} Fb:${meal.fib} O:${meal.oth}</div></div>
                    <div class="flex-sb" style="gap:15px; align-items:flex-start;">
                        <span style="color:var(--pink); font-weight:700; margin-top:2px;">${meal.cal} kcal</span>
                        <button class="del-btn" onclick="deleteOverlayFoodMeal(${index})">‚úï</button>
                    </div>
                </div>`;
        });
    }
}

function deleteOverlayFoodMeal(index) {
    deleteFoodMeal(index);
    const h = history[activeDay];
    document.getElementById('foodHCal').value = h.cal;
    document.getElementById('foodHProt').value = h.prot;
    document.getElementById('foodHCarb').value = h.carb;
    document.getElementById('foodHFat').value = h.fat;
    document.getElementById('foodHFib').value = h.fib;
    document.getElementById('foodHOth').value = h.oth;
    renderFoodOverlayMeals();
}

function saveFoodDay() {
    history[activeDay].cal = parseInt(document.getElementById('foodHCal').value) || 0;
    history[activeDay].prot = parseInt(document.getElementById('foodHProt').value) || 0;
    history[activeDay].carb = parseInt(document.getElementById('foodHCarb').value) || 0;
    history[activeDay].fat = parseInt(document.getElementById('foodHFat').value) || 0;
    history[activeDay].fib = parseInt(document.getElementById('foodHFib').value) || 0;
    history[activeDay].oth = parseInt(document.getElementById('foodHOth').value) || 0;
    closeFoodLog();
}

function deleteFoodDayLog() {
    if(confirm(`Wipe all food data for ${activeDay}?`)) {
        history[activeDay].cal = 0; history[activeDay].prot = 0;
        history[activeDay].carb = 0; history[activeDay].fat = 0;
        history[activeDay].fib = 0; history[activeDay].oth = 0;
        history[activeDay].meals = [];
        closeFoodLog();
    }
}

function closeFoodLog() { 
    document.getElementById('foodLogOverlay').style.display = 'none'; 
    activeDay = DAYS[new Date().getDay()];
    updateAllUI();
}

// ==========================================
// HYDRATION TAB LOGIC
// ==========================================
function updateHydrationUI() {
    const grid = document.getElementById('hydWeekGrid'); grid.innerHTML = '';
    DAYS.forEach(d => {
        const h = history[d];
        grid.innerHTML += `
            <div class="day-btn" onclick="openHydLog('${d}')">
                <span style="font-size:9px; color:${d===activeDay?'#3498db':'#9a8fa0'}; font-weight:700;">${d}</span>
                <div class="ring-stack" style="width:48px; height:48px;">
                    ${drawRing((h.plain/HYD_TARGETS.plain)*100, 'var(--blue)', 48, 3)}
                    <div style="position:absolute; inset:4px">${drawRing((h.lemon/HYD_TARGETS.lemon)*100, 'var(--lemon)', 40, 3)}</div>
                    <div style="position:absolute; inset:8px">${drawRing((h.tea/HYD_TARGETS.tea)*100, 'var(--purple)', 32, 3)}</div>
                    <div style="position:absolute; inset:12px">${drawRing((h.chia/HYD_TARGETS.chia)*100, 'var(--aqua)', 24, 3)}</div>
                    <div style="position:absolute; inset:16px">${drawRing((h.othWat/HYD_TARGETS.oth)*100, 'var(--white)', 16, 3)}</div>
                </div>
            </div>`;
    });

    const isToday = activeDay === DAYS[new Date().getDay()];
    document.getElementById('hydActiveDayLabel').innerText = isToday ? "TODAY" : activeDay.toUpperCase();
    document.getElementById('hydMainLogTitle').innerText = isToday ? "üìã Today's Hydration Log" : `üìã ${activeDay}'s Log`;

    const drank = history[activeDay].wat;
    document.getElementById('hydGlassCount').innerText = drank;
    document.getElementById('hydWaterBar').style.width = Math.min(100, (drank / HYD_TARGETS.total) * 100) + '%';

    const drinkList = document.getElementById('hydDrinkList');
    if (history[activeDay].drinks.length === 0) {
        drinkList.innerHTML = `<p style="font-size:12px; color:var(--sub); text-align:center; padding:10px 0;">No water logged yet.</p>`;
    } else {
        drinkList.innerHTML = '';
        history[activeDay].drinks.forEach((d, index) => {
            drinkList.innerHTML += `
                <div class="drink-row">
                    <div><span style="font-size:18px; margin-right:8px;">${d.emoji}</span><span>${d.name}</span></div>
                    <button class="del-btn" onclick="deleteDrink(${index})">‚úï</button>
                </div>`;
        });
    }
}

function selectDrink(id, name, emoji) {
    document.getElementById('hyd-opt-plain').classList.remove('active');
    document.getElementById('hyd-opt-lemon').classList.remove('active');
    document.getElementById('hyd-opt-chia').classList.remove('active');
    document.getElementById(`hyd-opt-${id}`).classList.add('active');
    hydCurrentDrink = { id, name, emoji };
}

function incrementHydCategory(cat) { history[activeDay][cat] += 1; history[activeDay].wat += 1; }

function logHydWater() {
    history[activeDay].drinks.push({ name: hydCurrentDrink.name, emoji: hydCurrentDrink.emoji, type: hydCurrentDrink.id });
    incrementHydCategory(hydCurrentDrink.id); updateAllUI();
}

function logHydCustomDrink() {
    const name = document.getElementById('hydCdName').value;
    const emoji = document.getElementById('hydCdEmoji').value || 'ü•§';
    if (name) {
        history[activeDay].drinks.push({ name: name, emoji: emoji, type: 'othWat' });
        incrementHydCategory('othWat');
        document.getElementById('hydCdName').value = ''; document.getElementById('hydCdEmoji').value = '';
        updateAllUI();
    } else alert("Please enter a drink name.");
}

function logHydWellnessTea() {
    history[activeDay].drinks.push({ name: 'Wellness Tea', emoji: 'üåø', type: 'tea' });
    incrementHydCategory('tea'); updateAllUI(); alert("üåø Wellness Tea logged!");
}

function deleteDrink(index) {
    const drink = history[activeDay].drinks[index];
    const cat = drink.type || 'plain';
    history[activeDay][cat] = Math.max(0, history[activeDay][cat] - 1);
    history[activeDay].wat = Math.max(0, history[activeDay].wat - 1);
    history[activeDay].drinks.splice(index, 1); updateAllUI();
}

function openHydLog(day) {
    activeDay = day; const h = history[day];
    document.getElementById('hydLogTitle').innerText = `${day}'s Log Book`;
    document.getElementById('hydHPlain').value = h.plain || "";
    document.getElementById('hydHLemon').value = h.lemon || "";
    document.getElementById('hydHTea').value = h.tea || "";
    document.getElementById('hydHChia').value = h.chia || "";
    document.getElementById('hydHOth').value = h.othWat || "";
    renderHydOverlayDrinks();
    document.getElementById('hydLogOverlay').style.display = 'block';
    updateAllUI();
}

function renderHydOverlayDrinks() {
    const list = document.getElementById('hydOverlayDrinkList');
    if (history[activeDay].drinks.length === 0) {
        list.innerHTML = `<p style="font-size:12px; color:var(--sub); padding:10px 0;">No drinks logged.</p>`;
    } else {
        list.innerHTML = '';
        history[activeDay].drinks.forEach((d, index) => {
            list.innerHTML += `<div class="drink-row" style="padding: 8px 0;">
                <div><span style="font-size:16px;">${d.emoji}</span> <span style="margin-left:5px;">${d.name}</span></div>
                <button class="del-btn" onclick="deleteOverlayDrink(${index})">‚úï</button></div>`;
        });
    }
}

function deleteOverlayDrink(index) {
    deleteDrink(index);
    const h = history[activeDay];
    document.getElementById('hydHPlain').value = h.plain; document.getElementById('hydHLemon').value = h.lemon;
    document.getElementById('hydHTea').value = h.tea; document.getElementById('hydHChia').value = h.chia; document.getElementById('hydHOth').value = h.othWat;
    renderHydOverlayDrinks();
}

function saveHydDay() {
    history[activeDay].plain = parseInt(document.getElementById('hydHPlain').value) || 0;
    history[activeDay].lemon = parseInt(document.getElementById('hydHLemon').value) || 0;
    history[activeDay].tea = parseInt(document.getElementById('hydHTea').value) || 0;
    history[activeDay].chia = parseInt(document.getElementById('hydHChia').value) || 0;
    history[activeDay].othWat = parseInt(document.getElementById('hydHOth').value) || 0;
    const h = history[activeDay];
    h.wat = h.plain + h.lemon + h.tea + h.chia + h.othWat;
    closeHydLog();
}

function deleteHydDayLog() {
    if(confirm(`Wipe all hydration data for ${activeDay}?`)) {
        ['wat','plain','lemon','tea','chia','othWat'].forEach(cat => history[activeDay][cat] = 0);
        history[activeDay].drinks = []; closeHydLog();
    }
}

function closeHydLog() { 
    document.getElementById('hydLogOverlay').style.display = 'none'; 
    activeDay = DAYS[new Date().getDay()]; updateAllUI();
}

// ==========================================
// FASTING TAB LOGIC
// ==========================================
function updateFastingUI() {
    const grid = document.getElementById('fastWeekGrid'); grid.innerHTML = '';
    DAYS.forEach(d => {
        const dData = history[d];
        const fastPct = (dData.fastHours / FAST_TARGET) * 100;
        grid.innerHTML += `
            <div class="day-btn" onclick="openFastLog('${d}')">
                <span style="font-size:9px; color:${d===activeDay?'#00d68f':'#9a8fa0'}; font-weight:700;">${d}</span>
                <div class="ring-stack" style="width:44px; height:44px;">
                    ${drawRing(fastPct, 'var(--accent)', 44, 4)}
                </div>
            </div>`;
    });

    const isToday = activeDay === DAYS[new Date().getDay()];
    document.getElementById('fastMainLogTitle').innerText = isToday ? "üìã Today's Fasting History" : `üìã ${activeDay}'s History`;

    const fastList = document.getElementById('fastList');
    if (history[activeDay].fasts.length === 0) {
        fastList.innerHTML = `<p style="font-size:12px; color:var(--sub); text-align:center; padding:10px 0;">No fasts logged yet.</p>`;
    } else {
        fastList.innerHTML = '';
        history[activeDay].fasts.forEach((f, index) => {
            fastList.innerHTML += `
                <div class="fast-row">
                    <div>
                        <span style="font-size:16px; margin-right:8px;">‚ö°</span>
                        <span style="font-weight:700;">${f.hours.toFixed(1)} Hours</span>
                        <div style="font-size:10px; color:var(--sub); margin-top:2px;">${f.dateLabel}</div>
                    </div>
                    <button class="del-btn" onclick="deleteFast(${index})">‚úï</button>
                </div>`;
        });
    }
    renderTimerCard();
}

function renderTimerCard() {
    const container = document.getElementById('fastTimerContainer');
    if (fastIsFasting && fastStartTime) {
        container.classList.add('timer-active');
        container.innerHTML = `
            <h2 style="color:#fff; margin-bottom:5px;">Fasting...</h2>
            <div id="fastLiveTimer" style="font-size:54px; font-weight:900; font-variant-numeric:tabular-nums; color:var(--accent); margin:10px 0;">00:00:00</div>
            <div style="height:8px; background:rgba(255,255,255,0.1); border-radius:5px; margin-bottom:20px; overflow:hidden;">
                <div id="fastTimerProgress" style="width:0%; height:100%; background:linear-gradient(90deg, var(--accent), var(--blue)); transition: width 1s;"></div>
            </div>
            <button class="btn-danger" onclick="endFast()">‚èπ End Fast & Log</button>
        `;
        if (!fastTimerInterval) fastTimerInterval = setInterval(updateLiveTimer, 1000);
        updateLiveTimer();
    } else {
        container.classList.remove('timer-active');
        container.innerHTML = `
            <div style="font-size:48px; margin-bottom:12px;">üåô</div>
            <p style="color:var(--sub); font-size:13px; margin-bottom:20px;">Start your fast after your last meal (7 PM).</p>
            <button class="btn-primary" onclick="startFast()">‚ñ∂ Start Fasting</button>
        `;
        clearInterval(fastTimerInterval); fastTimerInterval = null;
    }
}

function startFast() {
    fastIsFasting = true; fastStartTime = Date.now();
    localStorage.setItem('mo_isFasting', JSON.stringify(fastIsFasting)); localStorage.setItem('mo_fastStartTime', JSON.stringify(fastStartTime));
    updateAllUI();
}

function endFast() {
    if (!fastStartTime) return;
    const elapsedMs = Date.now() - fastStartTime;
    const elapsedHours = elapsedMs / (1000 * 60 * 60);
    const today = DAYS[new Date().getDay()];
    history[today].fasts.push({ hours: elapsedHours, dateLabel: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) });
    history[today].fastHours += elapsedHours;

    fastIsFasting = false; fastStartTime = null;
    localStorage.setItem('mo_isFasting', JSON.stringify(fastIsFasting)); localStorage.setItem('mo_fastStartTime', JSON.stringify(fastStartTime));
    updateAllUI(); alert(`Fast ended! Logged ${elapsedHours.toFixed(1)} hours.`);
}

function updateLiveTimer() {
    if (!fastIsFasting || !fastStartTime) return;
    const el = document.getElementById('fastLiveTimer'); const prog = document.getElementById('fastTimerProgress');
    if(!el || !prog) return;

    const elapsed = Math.floor((Date.now() - fastStartTime) / 1000);
    const h = Math.floor(elapsed / 3600); const m = Math.floor((elapsed % 3600) / 60); const s = elapsed % 60;
    el.innerText = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    prog.style.width = Math.min(100, (elapsed / (FAST_TARGET * 3600)) * 100) + '%';
}

function deleteFast(index) {
    history[activeDay].fastHours = Math.max(0, history[activeDay].fastHours - history[activeDay].fasts[index].hours);
    history[activeDay].fasts.splice(index, 1); updateAllUI();
}

function openFastLog(day) {
    activeDay = day; 
    document.getElementById('fastLogTitle').innerText = `${day}'s Log Book`;
    document.getElementById('fastHFast').value = history[day].fastHours ? history[day].fastHours.toFixed(1) : "";
    renderFastOverlayFasts(); document.getElementById('fastLogOverlay').style.display = 'block'; updateAllUI();
}

function renderFastOverlayFasts() {
    const list = document.getElementById('fastOverlayFastList');
    if (history[activeDay].fasts.length === 0) list.innerHTML = `<p style="font-size:12px; color:var(--sub); padding:10px 0;">No fasts logged.</p>`;
    else {
        list.innerHTML = '';
        history[activeDay].fasts.forEach((f, index) => {
            list.innerHTML += `<div class="fast-row" style="padding: 8px 0;">
                <div><span style="font-size:16px;">‚ö°</span> <span style="margin-left:5px; font-weight:700;">${f.hours.toFixed(1)}h</span></div>
                <button class="del-btn" onclick="deleteOverlayFast(${index})">‚úï</button></div>`;
        });
    }
}

function deleteOverlayFast(index) { deleteFast(index); document.getElementById('fastHFast').value = history[activeDay].fastHours.toFixed(1); renderFastOverlayFasts(); }

function saveFastDay() { history[activeDay].fastHours = parseFloat(document.getElementById('fastHFast').value) || 0; closeFastLog(); }

function deleteFastDayLog() { if(confirm(`Wipe all fasting data for ${activeDay}?`)) { history[activeDay].fastHours = 0; history[activeDay].fasts = []; closeFastLog(); } }

function closeFastLog() { document.getElementById('fastLogOverlay').style.display = 'none'; activeDay = DAYS[new Date().getDay()]; updateAllUI(); }


// ==========================================
// STATS TAB LOGIC
// ==========================================
function updateStatsUI() {
    const currentWeight = weightLog.length > 0 ? weightLog[weightLog.length - 1].weight : STATS_PROFILE.startWeight;
    const totalLost = Math.max(0, STATS_PROFILE.startWeight - currentWeight).toFixed(2);
    
    document.getElementById('statCurrent').innerText = `${currentWeight} kg`;
    document.getElementById('statLost').innerText = `${totalLost} kg`;

    const heightM = STATS_PROFILE.heightCm / 100;
    const bmi = (currentWeight / (heightM * heightM)).toFixed(1);
    document.getElementById('bmiValue').innerText = bmi;
    
    let bmiCat = "Healthy", bmiCol = "var(--accent)", markerPct = 50;
    if (bmi < 18.5) { bmiCat = "Underweight"; bmiCol = "var(--blue)"; markerPct = 10; }
    else if (bmi >= 18.5 && bmi <= 24.9) { bmiCat = "Healthy Weight"; bmiCol = "var(--accent)"; markerPct = 35; }
    else if (bmi >= 25 && bmi <= 29.9) { bmiCat = "Overweight"; bmiCol = "var(--gold)"; markerPct = 65; }
    else { bmiCat = "Obese"; bmiCol = "var(--pink)"; markerPct = 90; }

    document.getElementById('bmiValue').style.color = bmiCol;
    document.getElementById('bmiText').innerText = `You are currently in the ${bmiCat} range.`;
    document.getElementById('bmiMarker').style.left = `${markerPct}%`;
    document.getElementById('bmiMarker').style.color = bmiCol;

    const rewList = document.getElementById('rewardsList'); rewList.innerHTML = '';
    STATS_MILESTONES.forEach(m => {
        const isUnlocked = totalLost >= m.kg; const progress = Math.min(100, (totalLost / m.kg) * 100);
        rewList.innerHTML += `
            <div style="background:var(--card2); padding:12px; border-radius:12px; margin-bottom:10px; border:1px solid ${isUnlocked ? 'var(--gold)' : 'transparent'}; opacity: ${isUnlocked ? '1' : '0.6'}; transition:0.3s;">
                <div class="flex-sb"><div style="font-weight:800; font-size:14px;">${m.icon} ${m.title}</div><div style="font-size:11px; font-weight:700; color:${isUnlocked ? 'var(--gold)' : 'var(--sub)'};">${isUnlocked ? 'UNLOCKED' : `-${m.kg}kg`}</div></div>
                <div style="font-size:11px; color:var(--sub); margin:6px 0;">${m.desc}</div>
                <div style="height:4px; background:var(--border); border-radius:2px; overflow:hidden;"><div style="height:100%; background:var(--gold); width:${progress}%;"></div></div>
            </div>`;
    });

    const histList = document.getElementById('weightHistoryList'); histList.innerHTML = '';
    [...weightLog].reverse().forEach((w, idx) => {
        const realIdx = weightLog.length - 1 - idx;
        histList.innerHTML += `<div class="history-row"><span style="color:var(--sub); font-size:12px;">${w.date}</span>
            <div style="display:flex; align-items:center; gap:15px;"><span style="font-weight:700;">${w.weight} kg</span>
            ${w.id !== 0 ? `<button class="del-btn" onclick="deleteStatsWeight(${realIdx})">‚úï</button>` : '<span style="width:20px;"></span>'}</div></div>`;
    });
}

function logStatsWeight() {
    const val = parseFloat(document.getElementById('statsWeightInput').value);
    if (val && val > 30) {
        weightLog.push({ date: new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }), weight: val, id: Date.now() });
        localStorage.setItem('mo_weights', JSON.stringify(weightLog));
        document.getElementById('statsWeightInput').value = ''; updateAllUI(); drawChart();
    }
}

function deleteStatsWeight(index) {
    if (index === 0) return; 
    weightLog.splice(index, 1); localStorage.setItem('mo_weights', JSON.stringify(weightLog)); updateAllUI(); drawChart();
}

function drawChart() {
    const canvas = document.getElementById('weightChart');
    if (!canvas || weightLog.length === 0) return;
    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1; const rect = canvas.getBoundingClientRect();
    if(rect.width === 0) return; // Canvas not visible yet
    canvas.width = rect.width * dpr; canvas.height = rect.height * dpr; ctx.scale(dpr, dpr);
    
    const W = rect.width; const H = rect.height; ctx.clearRect(0, 0, W, H);
    const pad = { t: 20, b: 20, l: 10, r: 10 }; const chartW = W - pad.l - pad.r; const chartH = H - pad.t - pad.b;
    const weights = weightLog.map(w => w.weight);
    const minW = Math.min(STATS_PROFILE.goalWeight - 1, ...weights); const maxW = Math.max(STATS_PROFILE.startWeight + 1, ...weights);
    
    const getX = (index) => pad.l + (index / Math.max(1, weightLog.length - 1)) * chartW;
    const getY = (weight) => pad.t + chartH - ((weight - minW) / (maxW - minW)) * chartH;

    const goalY = getY(STATS_PROFILE.goalWeight);
    ctx.beginPath(); ctx.setLineDash([5, 5]); ctx.moveTo(pad.l, goalY); ctx.lineTo(W - pad.r, goalY);
    ctx.strokeStyle = '#00d68f'; ctx.lineWidth = 1; ctx.stroke(); ctx.setLineDash([]);
    ctx.fillStyle = '#00d68f'; ctx.font = '10px sans-serif'; ctx.fillText('Goal (63kg)', pad.l, goalY - 5);

    if (weightLog.length > 1) {
        ctx.beginPath(); ctx.moveTo(getX(0), H - pad.b);
        weightLog.forEach((w, i) => ctx.lineTo(getX(i), getY(w.weight)));
        ctx.lineTo(getX(weightLog.length - 1), H - pad.b); ctx.closePath();
        const gradient = ctx.createLinearGradient(0, pad.t, 0, H - pad.b);
        gradient.addColorStop(0, 'rgba(245, 166, 35, 0.4)'); gradient.addColorStop(1, 'rgba(245, 166, 35, 0.0)');
        ctx.fillStyle = gradient; ctx.fill();

        ctx.beginPath();
        weightLog.forEach((w, i) => { if (i === 0) ctx.moveTo(getX(i), getY(w.weight)); else ctx.lineTo(getX(i), getY(w.weight)); });
        ctx.strokeStyle = '#f5a623'; ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.stroke();
    }

    weightLog.forEach((w, i) => {
        const x = getX(i); const y = getY(w.weight);
        ctx.beginPath(); ctx.arc(x, y, 4, 0, Math.PI * 2); ctx.fillStyle = '#1a1a24'; ctx.fill();
        ctx.lineWidth = 2; ctx.strokeStyle = '#f5a623'; ctx.stroke();
        if (i === weightLog.length - 1) { ctx.fillStyle = '#fff'; ctx.font = 'bold 12px sans-serif'; ctx.textAlign = 'center'; ctx.fillText(w.weight, x, y - 12); }
    });
}

// Initialize Application
initRituals();
updateAllUI();
if (fastIsFasting) { fastTimerInterval = setInterval(updateLiveTimer, 1000); }

// Initial draw for chart if stats happens to be open (unlikely on load, but safe)
setTimeout(drawChart, 100);
</script>
</body>
</html>
